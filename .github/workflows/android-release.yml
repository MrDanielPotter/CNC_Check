env:
  P4A_SDK_ROOT: $HOME/.buildozer/android/platform/android-sdk
  ANDROID_SDK_ROOT: $HOME/.buildozer/android/platform/android-sdk
  ANDROID_HOME: $HOME/.buildozer/android/platform/android-sdk
  ANDROIDAPI: "34"
  ANDROIDMINAPI: "26"
  ANDROIDNDKVER: "r25b"
  ANDROID_BUILD_TOOLS_VERSION: "34.0.0"

# ...
- name: Install Android SDK command-line tools into Buildozer SDK root
  run: |
    mkdir -p "${P4A_SDK_ROOT}/cmdline-tools"
    wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O /tmp/cli-tools.zip
    unzip -q /tmp/cli-tools.zip -d "${P4A_SDK_ROOT}/cmdline-tools"
    mv "${P4A_SDK_ROOT}/cmdline-tools/cmdline-tools" "${P4A_SDK_ROOT}/cmdline-tools/latest"
    echo "${P4A_SDK_ROOT}/cmdline-tools/latest/bin" >> $GITHUB_PATH
    echo "${P4A_SDK_ROOT}/platform-tools" >> $GITHUB_PATH

    # «Старый» путь для p4a/buildozer
    mkdir -p "${P4A_SDK_ROOT}/tools/bin"
    ln -sf "${P4A_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" "${P4A_SDK_ROOT}/tools/bin/sdkmanager"

- name: Accept licenses & install stable SDK packages
  run: |
    yes | "${P4A_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" --sdk_root="${P4A_SDK_ROOT}" --licenses || true
    "${P4A_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" --sdk_root="${P4A_SDK_ROOT}" \
      "platform-tools" "platforms;android-34" "build-tools;34.0.0"

    # Совместимость: если p4a просит preview 36.1.0-rc1, подсовываем ссылку на 34.0.0
    if [ ! -d "${P4A_SDK_ROOT}/build-tools/36.1.0-rc1" ]; then
      ln -s "${P4A_SDK_ROOT}/build-tools/34.0.0" "${P4A_SDK_ROOT}/build-tools/36.1.0-rc1"
    fi

    # Диагностика — увидите это в логах
    ls -la "${P4A_SDK_ROOT}/build-tools" || true
    "${P4A_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" --sdk_root="${P4A_SDK_ROOT}" --list | head -n 60 || true
